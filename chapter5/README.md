# 서비스: 클라이언트가 파드를 검색하고 통신을 가능하게 함

1. 서비스란? 파드가 다른 파드를 찾는 방법

       서비스가 필요한 이유
       - 파드는 일시적이다. 파드가 다른 파드를 위한 공간을 확보하려고 노드에서 제거되거나, 누군가 파드 수를 줄이거나, 클러스터 노드의 장애로 언제든 다른 노드로 이동할 수 있다.
       - 쿠버네티스는 노드에 파드를 스케줄링한 후 파드가 시작되기 바로 전의 파드의 IP 주소를 할당한다. 따라서 클라이언트는 서버 pod의 IP 주소를 미리 할 수 없다.
       - 수평 스케일링은 여러 파드가 동일한 서비스를 제공할 수 있음을 의미함. 각 파드는 고유한 IP 주소가 있다. 클라이언트는 서비스를 지원하는 파드의 수와 IP에 상관하지 않아야 한다.
       - 파드는 개별 IP 목록을 유지할 필요가 없다. 그 대신 모든 파드는 단일 IP 주소로 액세스 할 수 있어야 한다.  


       쿠버네티스의 서비스는 동일한 서비스를 제공하는 파드 그룹에 지속적인 단일 접점을 만들려고 할 때 생성하는 리소스.
       각 서비스는 서비스가 존재하는 동안 절대 바뀌지 않는 IP 주소와 포트가 있다.
       클라이언트는 해당 IP와 포트로 접속한 다음 해당 서비스를 지원하는 파드 중 하나로 연결 된다.
       클라이언트는 서비스를 제공하는 개별 파드의 위치를 알 필요 없으므로, 이 파드는 언제든지 클러스터 안에서 이동할 수 있다.
       
<center><img src="https://user-images.githubusercontent.com/91730236/157878478-be84aab6-6cf8-460e-b611-a41c064d110d.png" width="700" height="350"></center>      

       
       
       서비스의 생성 -> 서비스 연결은 서비스 뒷단의 모든 파드로 로드밸런싱 된다.
       레이블 셀렉터는 어떤 파드가 서비스에 속하는지 정한다.
       
<center><img src="https://user-images.githubusercontent.com/91730236/157879122-c8700e1a-9b59-4b11-88c0-5ea45d2d3aed.png" width="700" height="350"></center>


       kubectl expose로 서비스 생성 -> expose를 사용해서 레플리케이션컨트롤러를 노출하는데 사용
       
       src에서 kubia-svc.yaml create 후 get 조회  
       
       kubectl get svc
       NAME               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
       flink-jobmanager   ClusterIP      10.109.242.196   <none>        6123/TCP,6124/TCP,8081/TCP   61d
       kubernetes         ClusterIP      10.96.0.1        <none>        443/TCP                      161d
       kubia              ClusterIP      10.96.166.187    <none>        90/TCP                       10s
       kubia-http         LoadBalancer   10.100.233.74    <pending>     9090:31813/TCP               9d
       
       
       
       클러스터 내에서 서비스 테스트
       - 확실한 방법은 서비스의 클러스터 IP로 요청을 보내고 응답을 로그로 남기는 파드를 만드는 것.
       - 그런 다음 파드의 로그를 검사해 서비스의 응답이 무엇인지 확인할 수 있다.
       - 쿠버네티스 노드로 ssh로 접속하고 curl 명령을 실행 할 수 있다.
       - kubectl exec 명령어로 기존 파드에서 curl 명령을 실행할 수 있다.
       
       kubectl exec kubia-kkhk9 -- curl -s http://10.96.166.187:90
       You've hit kubia-tbg58
       
       동작순서
![kube_service drawio (2)](https://user-images.githubusercontent.com/91730236/157883721-5c1aeb39-e18b-4583-a648-e6662f266832.png)

       
       서비스의 세션 어피니티 구성 : 특정 클라이언트의 모든 요청을 매번 같은 파드로 리디렉션 하려면 spec: 속성에서 sessionAffinity: ClientIP라고 설정
       동일한 서비스에서 여러 개의 포트 노출 : 여러 포트가 있는 서비스를 만들 때는 각 포트의 이름을 지정해야 한다. 
       이름이 지정된 포트를 사용할 수 있다.
        

3. 클러스터 외부에 있는 서비스 연결
4. 외부 클라이언트에 서비스 노출
5. 인그레스 리소스로 서비스 외부 노출
6. 파드가 연결을 수락할 준비가 되었을 때 신호 보내기
7. 헤드리스 서비스로 개별 파드 찾기
8. 서비스 문제 해결



------------------------------
요약! ( 외부와 통신이 결정되는 부분 -> 제대로 학습 필요 )
